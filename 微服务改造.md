# 微服务改造优点
将应用拆分为小型，独立的服务，每个服务专注于特定的业务功能，使得可以独立开发，部署，扩展和维护。  
技术异构性：允许使用不同的技术栈和编程语言去实现独立的应用  

# 短链接微服务改造
<img width="861" height="531" alt="微服务改造注册中心nacos" src="https://github.com/user-attachments/assets/3867bb2f-e560-4c82-89cf-7f8d3c8bf511" />  

## 1： 下载Nacos

## 2： 服务中引用Nacos进行服务注册

## 3： 改造现有代码使用OpenFeign调用
调用方要引入openfeign依赖，启动类上面加对应的注册中心的注解，然后配置好yaml，设置一个application: name 对应的服务名,springboot 3.0之后不提供默认的负载均衡器，所以需要自己引入一个。  
写一个ShortLinkActualRemoteService @FeignClient("short-link-project")指代被调用方，    
&nbsp;&nbsp; 1 ：SpringCloud会自动去Nacos里面去找这个服务，不需要再代码里面写死ip，  
&nbsp;&nbsp; 2：如果我的短链接服务也就是被调用的服务有多个实例，feign会自动轮训调用，自动负载均衡。  
&nbsp;&nbsp; 3：自动序列化 / 反序列化 @RequestBody自动把DTO转化为JSON，返回值也自动转化为java对象，之前的httpUtil只能自己处理JSON  
&nbsp;&nbsp; 4：内置拦截器、超时、重试、熔断等微服务能力  
&nbsp;&nbsp; 5：写法更优雅，跟写 Controller 一样，调用接口就像调本地方法：  
&nbsp;&nbsp; ```
                 shortLinkFeignClient.updateShortLink(req);  
             ```  
Feign 是 Spring Cloud 官方推荐的 RPC 调用方式。总的来说单体项目用HttpUtil，微服务改造要用feign。  
## 4： 重构网关SpringCloud Gateway  
如果没有网关也就是 应用仅在外面一层前端的笼罩下，那么分发逻辑就要交给前端了，而且每个应用启动多个实例，都有负载均衡，前端不知道去调用哪个实例，黑白名单，用户登录，网关的作用：统一入口管理、统一鉴权与限流、读写分流、防攻击、隐藏内部微服务结构，让整个系统更稳定可扩展。
### 1：引入SpringCloud Gateway
Spring Cloud Gateway 是 Spring Cloud 官方的高性能、响应式网关，用来做请求路由、鉴权、限流、负载均衡、跨域处理，是微服务架构的流量入口。
网关也要引入nacos-discovery的依赖，这样把gateway也注册到nacos上面去，就能发现别的服务比如后管和中台，我们目前是根据它的前置路径去访问到对应的服务上去。
 
### 为什么说“不加网关，每个服务都要自己做 token 验证”？  

 
你可以这样回答：  
  
因为没有网关时，前端直接访问每个微服务。  
每个微服务不知道用户是否登录、是否有权限，所以必须实现自己的 token 验证逻辑。  
而使用网关后，可以把 token 鉴权集中在网关统一做，下游服务只需要专注自己的业务逻辑，减少重复代码，提高安全性与一致性。  

# 引入网关架构后如何访问中台？
因此 中台也要有自己的鉴权逻辑，我们使用和后管一样的逻辑，后管调用中台服务，也就是前端会传过来username和token，因此我们中台单独的鉴权也这样设置就好，如果登录的token在redis中失效了，也就是后管调用中台401了，我们这时候让它重新登陆就好，但是这中间有一段空档期，不太友好，因此我们可以使用自动续期，  
即token快失效了然后自动续期。中台所做的唯一的事情就是如果后管调用过来判断如果没有token也就是过期或者失效（可能是用户退出登录了），这时候需要返回一个401，这个东西应该交个前端去做，让它去做对应的跳转。
